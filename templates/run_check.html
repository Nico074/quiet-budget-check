{% extends "layout_app.html" %}
{% block title %}Run a check — Momentum Labs{% endblock %}

{% block content %}
<section class="premium-hero card">
  <div>
    <div class="premium-title">Run a check</div>
    <div class="premium-sub">Fast input, clean signal, instant preview.</div>
  </div>
  <div class="premium-chips">
    <a class="btn" href="/dashboard">Back</a>
    <button class="btn primary" type="button" id="runPreviewBtn">Preview</button>
  </div>
</section>

<section class="run-grid">
  <article class="card form-card">
    <div class="label">Inputs</div>
    <form id="checkForm" class="premium-form" method="post" action="/check">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <label>
        <span>Period</span>
        <select name="period">
          <option value="monthly">Monthly</option>
          <option value="fortnightly">Fortnightly</option>
          <option value="weekly">Weekly</option>
        </select>
      </label>
      <label>
        <span>Days left</span>
        <input id="daysLeft" name="days_left" placeholder="e.g. 12" inputmode="numeric" required />
      </label>
      <label>
        <span>Today’s expense</span>
        <input id="today" name="today" placeholder="e.g. 45" inputmode="decimal" required />
      </label>
      <label>
        <span>Net income</span>
        <input id="income" name="income" placeholder="e.g. 3200" inputmode="decimal" required />
      </label>
      <label>
        <span>Fixed expenses</span>
        <input id="fixed" name="fixed" placeholder="e.g. 2100" inputmode="decimal" required />
      </label>
      <label>
        <span>Recurring income (preview)</span>
        <input id="recurringIncome" placeholder="e.g. 120" inputmode="decimal" />
      </label>
      <label>
        <span>Recurring expenses (preview)</span>
        <input id="recurringExpenses" placeholder="e.g. 80" inputmode="decimal" />
      </label>
      <label>
        <span>Food (preview)</span>
        <input id="catFood" placeholder="e.g. 250" inputmode="decimal" />
      </label>
      <label>
        <span>Transport (preview)</span>
        <input id="catTransport" placeholder="e.g. 90" inputmode="decimal" />
      </label>
      <label>
        <span>Lifestyle (preview)</span>
        <input id="catLifestyle" placeholder="e.g. 140" inputmode="decimal" />
      </label>
      <label class="full">
        <span>Custom notes</span>
        <textarea id="notes" rows="4" placeholder="Add context for this check..."></textarea>
      </label>
      <div class="form-actions-row">
        <button class="btn primary" type="submit">Run check</button>
        <a class="btn" href="/history">View history</a>
      </div>
    </form>
  </article>

  <aside class="preview-stack">
    <article class="card preview-card">
      <div class="label">Live preview</div>
      <h3>Pace vs budget</h3>
      <div class="chart-placeholder short">Preview area</div>
      <div class="preview-kpis">
        <div class="mini">
          <div class="label">Daily budget</div>
          <div class="value" id="dailyBudget">$0</div>
        </div>
        <div class="mini">
          <div class="label">Status</div>
          <div class="value" id="statusText">Idle</div>
        </div>
      </div>
    </article>
    <article class="card tip-card">
      <div class="label">Tip</div>
      <h3>Keep it simple</h3>
      <div class="muted">Set a small safety buffer. Track the pace, not every micro-detail.</div>
    </article>
  </aside>
</section>

{% endblock %}

{% block scripts %}
<script>
  const els = {
    income: document.getElementById("income"),
    fixed: document.getElementById("fixed"),
    daysLeft: document.getElementById("daysLeft"),
    today: document.getElementById("today"),
    recurringIncome: document.getElementById("recurringIncome"),
    recurringExpenses: document.getElementById("recurringExpenses"),
    catFood: document.getElementById("catFood"),
    catTransport: document.getElementById("catTransport"),
    catLifestyle: document.getElementById("catLifestyle"),
    dailyBudget: document.getElementById("dailyBudget"),
    statusText: document.getElementById("statusText"),
    runPreviewBtn: document.getElementById("runPreviewBtn"),
  };

  const toNum = (el) => {
    const v = parseFloat(el?.value || "");
    return Number.isFinite(v) ? v : 0;
  };

  const fmt = (n) => `$${n.toFixed(2)}`;

  const updatePreview = () => {
    const income = toNum(els.income);
    const fixed = toNum(els.fixed);
    const days = toNum(els.daysLeft);
    const today = toNum(els.today);
    const recurringIncome = toNum(els.recurringIncome);
    const recurringExpenses = toNum(els.recurringExpenses);
    const categories = toNum(els.catFood) + toNum(els.catTransport) + toNum(els.catLifestyle);

    const netIncome = income + recurringIncome - fixed - recurringExpenses - categories;
    const dailyBudget = days > 0 ? netIncome / days : 0;
    if (els.dailyBudget) els.dailyBudget.textContent = fmt(dailyBudget);

    let status = "On track";
    if (dailyBudget <= 0) status = "Risk";
    else if (today > dailyBudget * 1.3) status = "Risk";
    else if (today > dailyBudget) status = "Watch";
    if (els.statusText) els.statusText.textContent = status;
  };

  document.querySelectorAll("#checkForm input, #checkForm textarea").forEach((el) => {
    el.addEventListener("input", updatePreview);
  });
  if (els.runPreviewBtn) {
    els.runPreviewBtn.addEventListener("click", updatePreview);
  }
  updatePreview();
</script>
{% endblock %}
