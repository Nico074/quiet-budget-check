{% extends "layout_app.html" %}
{% block title %}Run a Check â€¢ Momentum Labs{% endblock %}
{% block content %}
<section class="run-shell">
  <article class="card run-form-card">
    <div class="card-head">
      <h2>Run a check</h2>
      <span class="chip">Live preview</span>
    </div>
    <form id="checkForm" method="post" action="/check" class="run-form-grid">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

      <label>
        <span>Period</span>
        <select name="period">
          <option value="monthly">Monthly</option>
          <option value="fortnightly">Fortnightly</option>
          <option value="weekly">Weekly</option>
        </select>
      </label>
      <label>
        <span>Days left</span>
        <input id="daysLeft" type="number" name="days_left" placeholder="12" required />
      </label>

      <label>
        <span>Net income</span>
        <input id="income" type="number" name="income" placeholder="3200" required />
      </label>
      <label>
        <span>Fixed expenses</span>
        <input id="fixed" type="number" name="fixed" placeholder="2100" required />
      </label>

      <label>
        <span>Today's expense</span>
        <input id="today" type="number" name="today" placeholder="45" required />
      </label>
      <label>
        <span>Recurring income (preview)</span>
        <input id="recurringIncome" type="number" name="preview_recurring_income" placeholder="120" />
      </label>

      <label>
        <span>Recurring expenses (preview)</span>
        <input id="recurringExpenses" type="number" name="preview_recurring_expenses" placeholder="80" />
      </label>
      <label>
        <span>Food (preview)</span>
        <input id="catFood" type="number" name="preview_food" placeholder="250" />
      </label>

      <label>
        <span>Transport (preview)</span>
        <input id="catTransport" type="number" name="preview_transport" placeholder="90" />
      </label>
      <label>
        <span>Lifestyle (preview)</span>
        <input id="catLifestyle" type="number" name="preview_lifestyle" placeholder="140" />
      </label>

      <label class="full">
        <span>Notes (preview only)</span>
        <textarea id="notes" name="preview_notes" rows="3" placeholder="Add context for this scenario..."></textarea>
      </label>

      <div class="form-actions">
        <button class="btn primary" type="submit">Run check</button>
        <a class="btn" href="/history">View history</a>
      </div>
    </form>
  </article>

  <aside class="run-side">
    <article class="card side-widget">
      <h3>Preview status</h3>
      <p>Input values update the estimate before submission.</p>
      <div class="status-pill ok" id="statusText">System ready</div>
      <div class="preview-kpi-row">
        <div>
          <span class="muted">Estimated daily budget</span>
          <strong id="dailyBudget">$0.00</strong>
        </div>
      </div>
    </article>

    <article class="card side-widget">
      <h3>Quick navigation</h3>
      <div class="quick-grid">
        <a class="btn" href="/dashboard">Dashboard</a>
        <a class="btn" href="/history">History</a>
        <a class="btn" href="/goals">Goals</a>
        <a class="btn" href="/wallet">Wallet overview</a>
        <a class="btn" href="/account">Account</a>
        <a class="btn" href="/billing">Billing</a>
      </div>
    </article>
  </aside>
</section>
{% endblock %}

{% block scripts %}
<script>
  const els = {
    income: document.getElementById("income"),
    fixed: document.getElementById("fixed"),
    daysLeft: document.getElementById("daysLeft"),
    today: document.getElementById("today"),
    recurringIncome: document.getElementById("recurringIncome"),
    recurringExpenses: document.getElementById("recurringExpenses"),
    catFood: document.getElementById("catFood"),
    catTransport: document.getElementById("catTransport"),
    catLifestyle: document.getElementById("catLifestyle"),
    dailyBudget: document.getElementById("dailyBudget"),
    statusText: document.getElementById("statusText")
  };

  const toNum = (el) => {
    const n = Number.parseFloat(el?.value || "");
    return Number.isFinite(n) ? n : 0;
  };

  const updatePreview = () => {
    const income = toNum(els.income);
    const fixed = toNum(els.fixed);
    const today = toNum(els.today);
    const days = toNum(els.daysLeft);
    const recurringIncome = toNum(els.recurringIncome);
    const recurringExpenses = toNum(els.recurringExpenses);
    const variableCats = toNum(els.catFood) + toNum(els.catTransport) + toNum(els.catLifestyle);

    const net = income + recurringIncome - fixed - recurringExpenses - variableCats;
    const budget = days > 0 ? net / days : 0;
    els.dailyBudget.textContent = `$${budget.toFixed(2)}`;

    let status = "On track";
    if (budget <= 0) {
      status = "High risk";
    } else if (today > budget * 1.3) {
      status = "High risk";
    } else if (today > budget) {
      status = "Watch";
    }
    els.statusText.textContent = status;
  };

  document.querySelectorAll("#checkForm input, #checkForm textarea, #checkForm select").forEach((el) => {
    el.addEventListener("input", updatePreview);
    el.addEventListener("change", updatePreview);
  });
  updatePreview();
</script>
{% endblock %}
